<ion-content padding>

  <ion-row>
    <ion-col col-12 col-sm-12 col-lg-8>
      <h2 *ngIf="!accountService.acc.uuid">Création du compte ğchange</h2>
      <h2 *ngIf="accountService.acc.uuid">Modification du compte ğchange</h2>

      <form #accountForm="ngForm" (ngSubmit)="accountService.createOrModifyAccount(accountForm)" >
        <ion-list inset>

          <ion-item>
            <ion-label>UUID</ion-label>
            <ion-input type="text" value="{{ accountService.acc.uuid }}" disabled></ion-input>
          </ion-item>

          <ion-item>
            <ion-label>Pubkey</ion-label>
            <ion-input type="text" value="{{ accountService.acc.pub }}" disabled></ion-input>
          </ion-item>

          <ion-item >
            <ion-label>Nom public</ion-label>
            <ion-input type="text"
                       required
                       minlength="10"
                       maxlength="100"
                       [(ngModel)]="accountService.acc.title"
                       name="title"
                       placeholder="Nom sur ğchange."
                       #title="ngModel"
            ></ion-input>
          </ion-item>

          <ion-label class="error" [hidden]="title.valid || (title.pristine && title.untouched)">
            <span [hidden]="!title.errors || !title.errors.required">Ce champ est requis.</span>
            <span [hidden]="!title.errors || !title.errors.minlength">Au moins 10 caractères.</span>
            <span [hidden]="!title.errors || !title.errors.maxlength">Au plus 100 caractères.</span>
          </ion-label>

          <ion-item>
            <ion-label>Description</ion-label>
            <ion-textarea required
                          minlength="10"
                          maxlength="10000"
                          [(ngModel)]="accountService.acc.desc"
                          name="desc"
                          #desc="ngModel"
                          placeholder="Tapez votre texte ici."></ion-textarea>
          </ion-item>

          <ion-label class="error" [hidden]="desc.valid || (desc.pristine && desc.untouched)">
            <span [hidden]="!desc.errors || !desc.errors.required">Ce champ est requis.</span>
            <span [hidden]="!desc.errors || !desc.errors.minlength">Au moins 10 caractères.</span>
            <span [hidden]="!desc.errors || !desc.errors.maxlength">Au plus 100 caractères.</span>
          </ion-label>

          <ion-item>
            <ion-label>Adresse</ion-label>
            <ion-input type="text"
                       minlength="4"
                       maxlength="100"
                       [(ngModel)]="accountService.acc.address"
                       name="address"
                       #address="ngModel"
                       placeholder="Exemple : « 10 rue de la Monnaie Libre, ... »"
            ></ion-input>
          </ion-item>

          <ion-label class="error" [hidden]="address.valid || (address.pristine && address.untouched)">
            <span [hidden]="!address.errors || !address.errors.minlength">Au moins 4 caractères.</span>
            <span [hidden]="!address.errors || !address.errors.maxlength">Au plus 100 caractères.</span>
          </ion-label>

          <ion-item>
            <ion-label>Liens</ion-label>
            <ion-input type="text"
                       minlength="10"
                       maxlength="100"
                       [(ngModel)]="accountService.link"
                       name="link"
                       #link="ngModel"
                       placeholder="http://..." ></ion-input>
            <button ion-button type="none" item-right (click)="accountService.ajouterLien(accountService.link)" [disabled]="!link.valid || !accountService.link">Ajouter</button>
          </ion-item>

          <ion-label class="error" [hidden]="link.valid || (link.pristine && link.untouched)">
            <span [hidden]="!link.errors || !link.errors.minlength">Au moins 10 caractères.</span>
            <span [hidden]="!link.errors || !link.errors.maxlength">Au plus 100 caractères.</span>
          </ion-label>

          <ion-item *ngFor="let lien of accountService.acc.links">
            <ion-label>{{ lien }}</ion-label>
            <button ion-button item-right color="danger" (click)="accountService.retirerLien(lien)">Retirer</button>
          </ion-item>

          <h2>Document final généré, à signer</h2>
          <pre>{{ accountService.raw }}</pre>

          <h2>Signature électronique</h2>

          <ion-item>
            <ion-label>Identifiant secret</ion-label>
            <ion-input type="password"
                       [(ngModel)]="accountService.key.salt"
                       name="salt"
                       #salt="ngModel"
                       (ngModelChange)="accountService.verifieCle()"
                       placeholder="Tapez votre identifiant secret."></ion-input>
          </ion-item>

          <ion-item>
            <ion-label>Mot de passe</ion-label>
            <ion-input type="password"
                       [(ngModel)]="accountService.key.passwd"
                       name="passwd"
                       #passwd="ngModel"
                       (ngModelChange)="accountService.verifieCle()"
                       placeholder="Tapez votre mot de passe." ></ion-input>
          </ion-item>

          <ion-item [hidden]="accountService.key.ok || accountService.keypairService.computingKey">
            <ion-label>Tapez vos identifiants secrets pour déverrouiller le bouton « Valider ».</ion-label>
          </ion-item>
          <ion-item [hidden]="!accountService.key.ok">
            <ion-label>Trousseau généré correct.</ion-label>
          </ion-item>
          <ion-item [hidden]="!accountService.keypairService.computingKey">
            <ion-spinner item-left></ion-spinner>
            <ion-label>Vérification de la clé...</ion-label>
          </ion-item>

        </ion-list>
        <button type="submit" ion-button [disabled]="!accountForm.form.valid || !accountService.key.ok">Valider les modifications</button>
      </form>
    </ion-col>
  </ion-row>

</ion-content>
